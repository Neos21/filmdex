<div class="controllers">
  <div>
    <div [hidden]="isSubmitting || isConfirmedToClose"  class="text-bold"      >映画メタ情報        </div>
    <div [hidden]="isSubmitting || !isConfirmedToClose" class="warning-message">変更を破棄しますか？</div>
    <div [hidden]="!isSubmitting"                       class="info-message"   >更新中…            </div>  <!-- 下部でも出してる -->
  </div>
  <div>
    <button type="button" class="small-button" [disabled]="isLoading || isSubmitting" (click)="isConfirmedToClose = false" *ngIf="isConfirmedToClose">Cancel</button>
    <button type="button" class="small-button" [disabled]="isLoading || isSubmitting" (click)="onClose()">{{ isConfirmedToClose ? 'Yes Close' : 'Close' }}</button>
  </div>
</div>

<div [hidden]="!isLoading" class="info-message">読込中…</div>

<form [formGroup]="filmMetaForm" *ngIf="!isLoading">
  <dl>
    <dt>公開年・原題<ng-container *ngIf="film.japaneseTitle">・邦題</ng-container></dt>
    <dd>{{ film.publishedYear }}年 {{ film.title }}<ng-container *ngIf="film.japaneseTitle"> ({{ film.japaneseTitle }})</ng-container></dd>
    <dt>あらすじ</dt>
    <dd><ng-container *ngIf="film.scenario; else noScenario">{{ film.scenario }}</ng-container><ng-template #noScenario>(未入力)</ng-template></dd>
    <dt>感想</dt>
    <dd><ng-container *ngIf="film.review; else noReview">{{ film.review }}</ng-container><ng-template #noReview>(未入力)</ng-template></dd>
  </dl>
  
  <div class="table-wrapper">
    <table class="form-table">
      <caption>キャスト</caption>
      <thead>
        <tr>
          <th class="column-order"    >No</th>
          <th class="column-role"     >役名</th>
          <th class="column-name"     >名前</th>
          <th class="column-operation">操作</th>
        </tr>
      </thead>
      <tbody>
        <ng-container formArrayName="casts">
          <tr *ngFor="let cast of casts.controls; let i = index; let l = count" [formGroupName]="i" class="edit-row">
            <td class="column-order"    ><input type="text" formControlName="order" placeholder="順序" required readonly tabindex="-1"></td>
            <td class="column-role"     ><input type="text" formControlName="role"  placeholder="役名" required></td>
            <td class="column-name"     ><input type="text" formControlName="name"  placeholder="名前" required></td>
            <td class="column-operation">
              <div class="operation-buttons">
                <button type="button" [disabled]="isSubmitting || i === 0"     (click)="onUpCast(i)"    >↑</button>
                <button type="button" [disabled]="isSubmitting || i === l - 1" (click)="onDownCast(i)"  >↓</button>
                <button type="button" [disabled]="isSubmitting"                (click)="onRemoveCast(i)">×</button>
              </div>
            </td>
          </tr>
        </ng-container>
        <tr formGroupName="newCast">
          <td class="column-order"    >-</td>
          <td class="column-role"     ><input type="text" formControlName="role" placeholder="役名" required></td>
          <td class="column-name"     ><input type="text" formControlName="name" placeholder="名前" required></td>
          <td class="column-operation"><button type="button" [disabled]="filmMetaForm.controls.newCast.invalid || isSubmitting" (click)="onAddNewCast()">追加</button></td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="table-wrapper">
    <table class="form-table">
      <caption>スタッフ</caption>
      <thead>
        <tr>
          <th class="column-order"    >No</th>
          <th class="column-role"     >役職名</th>
          <th class="column-name"     >名前</th>
          <th class="column-operation">操作</th>
        </tr>
      </thead>
      <tbody>
        <ng-container formArrayName="staffs">
          <tr *ngFor="let staff of staffs.controls; let i = index; let l = count" [formGroupName]="i" class="edit-row">
            <td class="column-order"    ><input type="text" formControlName="order" placeholder="順序"   required readonly tabindex="-1"></td>
            <td class="column-role"     ><input type="text" formControlName="role"  placeholder="役職名" required></td>
            <td class="column-name"     ><input type="text" formControlName="name"  placeholder="名前"   required></td>
            <td class="column-operation">
              <div class="operation-buttons">
                <button type="button" [disabled]="isSubmitting || i === 0"     (click)="onUpStaff(i)"    >↑</button>
                <button type="button" [disabled]="isSubmitting || i === l - 1" (click)="onDownStaff(i)"  >↓</button>
                <button type="button" [disabled]="isSubmitting"                (click)="onRemoveStaff(i)">×</button>
              </div>
            </td>
          </tr>
        </ng-container>
        <tr formGroupName="newStaff">
          <td class="column-order"    >-</td>
          <td class="column-role"     ><input type="text" formControlName="role" placeholder="役職名" required></td>
          <td class="column-name"     ><input type="text" formControlName="name" placeholder="名前"   required></td>
          <td class="column-operation"><button type="button" [disabled]="filmMetaForm.controls.newStaff.invalid || isSubmitting" (click)="onAddNewStaff()">追加</button></td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="table-wrapper">
    <table class="form-table">
      <caption>タグ</caption>
      <thead>
        <tr>
          <th class="column-order"    >No</th>
          <th class="column-name"     >タグ名</th>
          <th class="column-operation">操作</th>
        </tr>
      </thead>
      <tbody>
        <ng-container formArrayName="tags">
          <tr *ngFor="let tag of tags.controls; let i = index; let l = count" [formGroupName]="i" class="edit-row">
            <td class="column-order"    ><input type="text" formControlName="order" placeholder="順序"   required readonly tabindex="-1"></td>
            <td class="column-name"     ><input type="text" formControlName="name"  placeholder="タグ名" required></td>
            <td class="column-operation">
              <div class="operation-buttons">
                <button type="button" title="上へ" [disabled]="isSubmitting || i === 0"     (click)="onUpTag(i)"    >↑</button>
                <button type="button" title="下へ" [disabled]="isSubmitting || i === l - 1" (click)="onDownTag(i)"  >↓</button>
                <button type="button" title="削除" [disabled]="isSubmitting"                (click)="onRemoveTag(i)">×</button>
              </div>
            </td>
          </tr>
        </ng-container>
        <tr formGroupName="newTag">
          <td class="column-order"    >-</td>
          <td class="column-name"     ><input type="text" formControlName="name" placeholder="タグ名" required></td>
          <td class="column-operation"><button type="button" [disabled]="filmMetaForm.controls.newTag.invalid || isSubmitting" (click)="onAddNewTag()">追加</button></td>
        </tr>
      </tbody>
    </table>
  </div>
</form>

<div class="controllers">
  <div>
    <div [hidden]="!isSubmitting" class="info-message" >更新中…          </div>
    <div [hidden]="!errorMessage" class="error-message">{{ errorMessage }}</div>
  </div>
  <div><button type="button" (click)="onUpdate()" [disabled]="isLoading || isSubmitting || isDisabledUpdateButton()">更新</button></div>
</div>
