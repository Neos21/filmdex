<div class="controllers">  <!-- 高さ確保用 -->
  <div [hidden]="editingFilm != null || removingFilm != null">  <!-- モーダル表示時は操作させないように非表示にする -->
    <div class="controllers-container">  <!-- display: grid を指定しており [hidden] に勝ってしまうので入れ子にする -->
      <form [formGroup]="searchForm" *ngIf="searchForm" (submit)="onSearch()">
        <select formControlName="targetColumn" (change)="onChangeSearchTargetColumn()">
          <option *ngFor="let searchTargetColumn of searchTargetColumns" [ngValue]="searchTargetColumn.value">{{ searchTargetColumn.name }}</option>
        </select>
        <select formControlName="publishedAge" (change)="onChangeSearchPublishedAge()" *ngIf="searchForm.controls.targetColumn.value === 'published_age'">
          <option *ngFor="let searchPublishedAge of searchPublishedAges" [ngValue]="searchPublishedAge.age">{{ searchPublishedAge.age }} 年代</option>
        </select>
        <input type="text" formControlName="searchText" placeholder="検索文字列" [hidden]="searchForm.controls.targetColumn.value === 'published_age'">
        <button type="submit" [disabled]="searchForm.invalid || isInvalidPublishedYear() || isLoading || isSubmitting">検索</button>
      </form>
      <div><button type="button" (click)="onLoad()" [disabled]="isLoading || isSubmitting">Reload</button></div>
    </div>
  </div>
</div>

<div class="message-container">  <!-- 高さ確保用 -->
  <div [hidden]="!isLoading"                 class="info-message" >{{ isSearch ? '検索中…' : '読込中…' }}</div>
  <div [hidden]="isLoading || !isSubmitting" class="info-message" >{{ isCreate ? '登録中…' : '更新中…' }}</div>
  <div [hidden]="!errorMessage"              class="error-message">{{ errorMessage }}</div>
</div>

<form [formGroup]="filmsForm" *ngIf="filmsForm" class="table-wrapper">
  <table class="form-table" [hidden]="editingFilm != null || removingFilm != null">  <!-- モーダル表示時は表を操作させないように非表示にする -->
    <thead>
      <tr>
        <th class="column-published-year">公開年</th>
        <th class="column-title"         >原題</th>
        <th class="column-japanese-title">邦題</th>
        <th class="column-scenario"      >あらすじ</th>
        <th class="column-review"        >感想</th>
        <th class="column-operation"     >操作</th>
      </tr>
    </thead>
    <tbody>
      <ng-container formArrayName="films" *ngIf="films.controls.length > 0; else notFound">
        <tr *ngFor="let film of films.controls; let i = index" [formGroupName]="i" class="edit-row">
          <td class="column-published-year"><input type="text" formControlName="publishedYear" placeholder="公開年"   (blur)="onUpdate(film)" required minlength="4" maxlength="4" pattern="^[1-9][0-9]{3}$"></td>
          <td class="column-title"         ><input type="text" formControlName="title"         placeholder="原題"     (blur)="onUpdate(film)" required                                                      ></td>
          <td class="column-japanese-title"><input type="text" formControlName="japaneseTitle" placeholder="邦題"     (blur)="onUpdate(film)"                                                               ></td>
          <td class="column-scenario"      ><input type="text" formControlName="scenario"      placeholder="あらすじ" (blur)="onUpdate(film)"                                                               ></td>
          <td class="column-review"        ><input type="text" formControlName="review"        placeholder="感想"     (blur)="onUpdate(film)"                                                               ></td>
          <td class="column-operation"     >
            <div class="operation-buttons">
              <button type="button" title="詳細" (click)="onStartEditMeta(film)" [disabled]="isSubmitting"                                 >→</button>
              <button type="button" title="更新" (click)="onUpdate(film)"        [disabled]="isSubmitting || film.pristine || film.invalid">○</button>
              <button type="button" title="削除" (click)="onStartRemove(film)"   [disabled]="isSubmitting"                                 >×</button>
            </div>
          </td>
        </tr>
      </ng-container>
      <ng-template #notFound>
        <tr>
          <td colspan="6" class="not-found warning-message">{{ isSearch ? '条件に合致する映画はありません' : '1件も映画が登録されていません' }}</td>
        </tr>
      </ng-template>
      <tr formGroupName="newFilm">
        <td class="column-published-year"><input type="text" formControlName="publishedYear" placeholder="公開年"   required minlength="4" maxlength="4" pattern="^[1-9][0-9]{3}$"></td>
        <td class="column-title"         ><input type="text" formControlName="title"         placeholder="原題"     required                                                      ></td>
        <td class="column-japanese-title"><input type="text" formControlName="japaneseTitle" placeholder="邦題"                                                                   ></td>
        <td class="column-scenario"      ><input type="text" formControlName="scenario"      placeholder="あらすじ"                                                               ></td>
        <td class="column-review"        ><input type="text" formControlName="review"        placeholder="感想"                                                                   ></td>
        <td class="column-operation"     ><button type="button" title="登録" class="button-create" (click)="onCreate()" [disabled]="filmsForm.controls.newFilm.invalid || isLoading || isSubmitting">登録</button></td>
      </tr>
    </tbody>
  </table>
</form>

<div class="modal-wrapper" *ngIf="editingFilm != null">
  <div class="modal-container">
    <app-film-meta [film]="editingFilm" (onClosed)="onEndEditMeta()"></app-film-meta>
  </div>
</div>

<div class="modal-wrapper" *ngIf="removingFilm != null">
  <div class="modal-container">
    <div class="removing-confirmation-modal">
      <h2>本当に削除しますか？</h2>
      <p>{{ removingFilm.publishedYear }}年 {{ removingFilm.title }}</p>
      <div class="buttons">
        <div><button type="button" (click)="removingFilm = null" [disabled]="isSubmitting">Cancel</button></div>
        <div><button type="button" (click)="onRemove()"          [disabled]="isSubmitting">Remove</button></div>
      </div>
    </div>
  </div>
</div>
